#!/usr/bin/env bash

###

# -- script to set colors generated by wal
# https://github.com/dylanaraps/pywal
# my unix skill is far from good, but it works for now :D


ubersicht_css="$HOME/dotfiles/conf/osx/ubersicht/widgets/nerdbar.widget/colors.css"
wal_css="$HOME/.cache/wal/colors.css"
chunkwmrc=$HOME/dotfiles/conf/osx/chunkwm/.chunkwmrc
alacritty_conf=$HOME/dotfiles/conf/osx/alacritty/alacritty.yml

# import colors from wal
source "$HOME/.cache/wal/colors.sh"

# update Übersicht with wal colors
reload_bar() {
  # if the wal css is present, remove the last 28 lines (length of wal css)
  if grep -q :root "$ubersicht_css" ;then
    ed -s "$ubersicht_css" <<< $'-27,$d\nwq'
  fi
  cat "$wal_css" >> "$ubersicht_css"
  osascript -e 'tell application "Übersicht" to refresh'
}

# update chunkwm tiling border color with color1 from wal
reload_chunkwm_tile() {
  # find chunkc set focused_border_color and replace 0xff this
  sed -i.bak "s/.*chunkc set focused_border_color.*/chunkc set focused_border_color          ${color2}ff/" "$chunkwmrc"
  sed -i.bak "s/0x#/0x/" "$chunkwmrc"
  brew services restart chunkwm
}

reload_alacritty_color() {
  # forground and background
  sed -i.bak "s/.*background:.*/    background: '0x${color0}'/" "$alacritty_conf"
  sed -i.bak "s/.*foreground:.*/    foreground: '0x${color7}'/" "$alacritty_conf"

  # cursor
  sed -i.bak "s/.*text:.*/    text:   '0x${color0}'/" "$alacritty_conf"
  sed -i.bak "s/.    *cursor:.*/    cursor: '0x${color7}'/" "$alacritty_conf"

  # normal colors
  sed -i.bak "s/.*black:.*/    black:   '0x${color0}'/" "$alacritty_conf"
  sed -i.bak "s/.*red:.*/    red:     '0x${color1}'/" "$alacritty_conf"
  sed -i.bak "s/.*green:.*/    green:   '0x${color2}'/" "$alacritty_conf"
  sed -i.bak "s/.*yellow:.*/    yellow:  '0x${color3}'/" "$alacritty_conf"
  sed -i.bak "s/.*blue:.*/    blue:    '0x${color4}'/" "$alacritty_conf"
  sed -i.bak "s/.*magenta:.*/    magenta: '0x${color5}'/" "$alacritty_conf"
  sed -i.bak "s/.*cyan:.*/    cyan:    '0x${color6}'/" "$alacritty_conf"
  sed -i.bak "s/.*white:.*/    white:   '0x${color7}'/" "$alacritty_conf"
  sed -i.bak "s/0x#/0x/" "$alacritty_conf"


  # bright colors

  # dim colors
  # replace only the black found 1 row below 'dim:'
  ex -s +"/bright:/+1 s/.*black:.*/    black:   '0x${color8}'/ | x" "$alacritty_conf"

  # wal colors are formatted #rrggbb, alacritty is 0xrrggbb
  sed -i.bak "s/0x#/0x/" "$alacritty_conf"

  open "/Applications/Alacritty.app"
}

main() {
  reload_alacritty_color
  reload_bar
  reload_chunkwm_tile
}

main
